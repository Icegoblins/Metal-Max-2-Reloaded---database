<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>MM2R Hunter Database - WasteLand v2.2</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<div class="top-bar">
    <div class="brand-zone"><img src="logo.png" alt="MM LOGO" class="mm-logo"></div>
    <div class="status-bridge">
        <div class="status-text"><span>DECODING: ACTIVE</span><span>SIGNAL: MAX [||||||]</span><span>LOC: 35.68, 139.69</span></div>
        <div class="bridge-line"></div>
    </div>
    <div class="nav-zone"><div class="tabs" id="tab-bar"></div></div>
</div>

<div class="container">
    <div class="list-panel" id="item-list"></div>
    <div class="detail-panel" id="detail-scroller">
        <div class="top-section">
            <div class="visual-box" id="pic-area">
                <div class="scanning-line"></div>
                <div class="poster-layer">
                    <div class="poster-name" id="post-name">NAME</div>
                    <div class="poster-money" id="post-money">000,000G</div>
                </div>
                <div id="img-container" style="width: 100%; display:flex; justify-content:center; align-items:center;">
                    <span>ANALYZING...</span>
                </div>
            </div>
            <div class="info-content">
                <div class="info-header">
                    <div class="item-title-box"><h1 class="item-name" id="det-name">HUNTER DATABASE</h1></div>
                    <div class="system-status">DECODING: ACTIVE<br>SIGNAL: STRONG [||||||  ]<br>REF: MM2R-DB-V2.2</div>
                </div>
                <div class="stats-grid" id="stats-grid"></div>
            </div>
        </div>
        <div class="desc-area" id="desc-text"></div>
    </div>
</div>


<div id="custom-modal" class="mm-modal-overlay">
    <div class="mm-modal-box" id="modal-box">
        <div class="mm-modal-header">
            <span id="modal-title">SYSTEM MESSAGE</span>
            <span style="opacity: 0.5;">CODE: 404-NOT-FOUND</span>
        </div>
        <div class="mm-modal-content" id="modal-message">
            </div>
        <div class="mm-modal-footer">
            <button class="mm-btn" onclick="closeModal()">确认</button>
        </div>
    </div>
</div>


<script>
    // 全局渲染器字典
    // 必须最先定义，否则后面的脚本找不到这个字典
    window.PageRenderers = {};
    window.registerPageRenderer = function(name, config) {
        window.PageRenderers[name] = config;
        console.log(`Renderer Registered: ${name}`); // 调试用
    };
</script>
<script src="js/pages/shangjinshou.js"></script>
<script src="js/pages/utils.js"></script>
<script src="js/pages/renleiwuqi.js"></script>
<script src="js/pages/renleifangju.js"></script>
<script src="js/pages/renleidaoju.js"></script>
<script src="js/pages/zhanche_zhuangbei.js"></script>

<script>
    // --- 全局状态 ---
    let currentRawData = [];    // 存储当前分类的原始数据（用于过滤）
    let typewriterTimer = null; // 打字机计时器
    window.currentStarIdx = 0;  // 当前星级：0-通常, 1-1星, 2-2星, 3-3星
    window.lastSelectedItem = null; // 最后选中的物品对象
    window.currentGroupItems = [];  // 当前选中的进化支系/分组内的所有物品

    // --- 初始化 ---
    window.onload = async () => {
        try {
            const res = await fetch('config.json');
            const categories = await res.json();
            renderTabs(categories);
            if(categories.length > 0) loadCategory(categories[0]);
        } catch (e) {
            document.body.innerHTML = "<h1 style='padding:50px; color:red;'>CRITICAL ERROR: DATABASE OFFLINE</h1>";
        }
    };

    function renderTabs(cats) {
    document.getElementById('tab-bar').innerHTML = cats.map(c =>
        // 确保点击顶栏 Tab 时不保留搜索内容
        `<div class="tab-btn" id="t-${c}" onclick="loadCategory('${c}', false)">${c}</div>`
    ).join('');
}

    // --- 数据加载与过滤 ---
    async function loadCategory(name, isJump = false) {
    // 只有在点击真正的 Tab 时才清空搜索状态
    if (!isJump) window.pendingTargetName = null;

    // Tab 高亮切换
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    const btn = document.getElementById(`t-${name}`);
    if (btn) btn.classList.add('active');

    const listPanel = document.getElementById('item-list');

    // 如果是搜索结果模式，不需要 fetch 单个文件
    if (name === "搜索结果") {
        renderSearchUI(listPanel);
        return;
    }

    try {
        const res = await fetch(`data/${encodeURIComponent(name)}.json`);
        const json = await res.json();
        currentRawData = Array.isArray(json) ? json : (json.data || []);

        const searchVal = isJump ? "" : (document.getElementById('db-search')?.value || "");
        renderDefaultUI(listPanel, searchVal);
        execFilter();
    } catch (e) {
        console.error("加载失败:", e);
    }
}

// 提取 UI 渲染为独立函数，保持代码整洁
function renderDefaultUI(container, val) {
    container.innerHTML = `
        <div class="search-bar" style="padding:10px; background:#0a0a0a; border-bottom:1px solid #333; position:sticky; top:0; display:flex; gap:8px;">
            <input type="text" id="db-search" value="${val}" placeholder="名称/属性/特性..."
                   style="flex:1; background:#000; border:1px solid #333; color:#50ff7d; padding:8px; outline:none;"
                   oninput="execFilter()">
            <button onclick="handleManualGlobalSearch()" style="background:#1a1a1a; border:1px solid #50ff7d; color:#50ff7d; cursor:pointer; padding:0 8px;">全局</button>
            <button onclick="resetSearch()" style="background:#1a1a1a; border:1px solid #50ff7d; color:#50ff7d; cursor:pointer; padding:0 8px;">重置</button>
        </div>
        <div id="list-content"></div>`;
}

    // 核心过滤逻辑 - 升级版：支持多维度检索与全局联想
    function execFilter() {
        const query = document.getElementById('db-search').value.toLowerCase().trim();
        const activeTab = document.querySelector('.tab-btn.active').innerText;

        // 1. 如果搜索框为空，渲染当前分类全部数据
        if (!query) {
            renderGroupedData(currentRawData, activeTab);
            return;
        }

        // 2. 多维度模糊匹配逻辑
        const filtered = currentRawData.filter(it => {
            return (it.名称 && it.名称.toLowerCase().includes(query)) ||
                   (it.改造支系 && it.改造支系.toLowerCase().includes(query)) ||
                   (it.属性 && it.属性.toLowerCase().includes(query)) ||
                   (it.特性 && it.特性.toLowerCase().includes(query)) ||
                   (it.类型 && it.类型.toLowerCase().includes(query));
        });

        // 3. 自动联动：如果当前分类搜不到，且字数 > 1，控制台静默提示或准备全局搜索
        if (filtered.length === 0 && query.length > 1) {
            console.log(`>> 当前分类 [${activeTab}] 无结果，建议点击右侧 [全局检索]`);
        }
        if (filtered.length === 0 && query.length >= 2) {}
        renderGroupedData(filtered, activeTab);

    }

    // 提取渲染逻辑
    function renderGroupedData(data, activeTab) {
        if (activeTab === "战车装备") {
            const groupsMap = {};
            data.forEach(item => {
                if (item.星级 === 0 || !item.星级) {
                    let gName = item.分类 || "其他";
                    if (item.部位 && item.部位.includes("固定")) {
                        gName = item.部位 || "固定";
                    } else if (gName === "引擎" && item.改造支系 && item.改造支系 !== "-") {
                        gName = `引擎 - ${item.改造支系}`;
                    }
                    if (!groupsMap[gName]) groupsMap[gName] = [];
                    groupsMap[gName].push(item);
                }
            });
            const groupedData = Object.keys(groupsMap).map(k => ({ groupTitle: k, items: groupsMap[k] }));
            renderList(groupedData, true);
        } else {
            const groupKeyMap = { "人类防具": "部位", "人类道具": "类型", "人类武器": "类型", "赏金首": "级别" };
            renderList(data, false, groupKeyMap[activeTab] || "类型");
        }
    }

/**
 * 提取出来的统一渲染逻辑，方便 execFilter 调用
 */
function renderGroupedList(data, activeTab) {
    if (activeTab === "战车装备") {
        const groupsMap = {};
        data.forEach(item => {
            // 只在列表中显示 0 星基础物品，防止星级条目刷屏
            if (item.星级 === 0 || !item.星级) {
                let gName = item.分类 || "其他";
                if (item.部位 && item.部位.includes("固定")) {
                    gName = "[ 固定装备 ]";
                } else if (gName === "引擎" && item.改造支系 && item.改造支系 !== "-") {
                    gName = `引擎 - ${item.改造支系}`;
                }
                if (!groupsMap[gName]) groupsMap[gName] = [];
                groupsMap[gName].push(item);
            }
        });
        const groupedData = Object.keys(groupsMap).map(k => ({ groupTitle: k, items: groupsMap[k] }));
        renderList(groupedData, true);
    } else {
        const groupKeyMap = { "人类防具": "部位", "人类道具": "类型", "人类武器": "类型", "赏金首": "级别" };
        renderList(data, false, groupKeyMap[activeTab] || "类型");
    }
}

    // --- 统一列表渲染 ---
    function renderList(data, isPreGrouped, groupKey = "") {
    const container = document.getElementById('list-content');
    container.innerHTML = '';

    let groups = {};
    if (isPreGrouped) {
        data.forEach(g => { groups[g.groupTitle] = g.items; });
    } else {
        data.forEach(item => {
            const key = item[groupKey] || "其他";
            if (!groups[key]) groups[key] = [];
            groups[key].push(item);
        });
    }

    for (const [groupName, items] of Object.entries(groups)) {
        const groupDiv = document.createElement('div');
        groupDiv.className = 'list-group-wrapper';
        groupDiv.innerHTML = `
            <div class="sticky-group-header" onclick="this.parentElement.classList.toggle('is-folded')">
                <span class="fold-icon">▼</span>
                <span class="title-text">${groupName}</span>
                <span class="count-tag">${items.length}</span>
            </div>
            <ul class="group-item-list"></ul>
        `;

        const ul = groupDiv.querySelector('ul');
        items.forEach((item, index) => {
            const li = document.createElement('li');
            li.className = 'nav-item';
            li.innerText = `[${(index + 1).toString().padStart(3, '0')}] ${item.名称}`;

            li.onclick = (e) => {
                e.stopPropagation();
                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                li.classList.add('active');

                window.allData = currentRawData;

                // 关键点：进化轴需要展示的是该支系的所有 0 星阶段，以便跳转
                // 我们直接把当前这个小分组（例如“引擎 - 龙卷”）的所有 0 星项传过去
                window.currentGroupItems = items;

                showDetail(item);
            };
            ul.appendChild(li);
        });
        container.appendChild(groupDiv);
    }

    if (!window.pendingTargetName) {
        const firstLi = container.querySelector('.nav-item');
        if (firstLi) firstLi.click();
    }
}

    function highlightAndScrollTo(name) {
    // 1. 清除所有列表项的旧高亮
    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));

    // 2. 寻找目标并高亮
    const listItems = document.querySelectorAll('.nav-item');
    for (let li of listItems) {
        // 这里的匹配逻辑要精准，防止“越野车”匹配到“越野车导弹”
        // 假设 innerText 格式是 [001] 名称
        const displayName = li.innerText.replace(/^\[\d+\]\s*/, '');
        if (displayName === name) {
            li.classList.add('active');
            // 滚动到中心位置
            li.scrollIntoView({ behavior: 'smooth', block: 'center' });
            break;
        }
    }
}
    // --- 详情渲染 ---
    async function showDetail(item) {
        if (!item) return;
        window.lastSelectedItem = item;

        const activeTab = document.querySelector('.tab-btn.active').innerText;
        const renderer = PageRenderers[activeTab];

        // 1. 设置皮肤与基础信息
        document.getElementById('pic-area').className = 'visual-box ' + (renderer?.skin || 'default');
        document.getElementById('det-name').innerText = item.名称;
        document.getElementById('post-name').innerText = item.名称;

        // 价格逻辑处理
        const price = item.价格;
        document.getElementById('post-money').innerText = (price === 0 || !price) ? "非卖品" : (price.toLocaleString() + " G");

        // 2. 调用插件渲染属性网格
        const statsGrid = document.getElementById('stats-grid');
        if (renderer) {
            statsGrid.innerHTML = renderer.renderStats(item);
            if (renderer.onUpdateVisual) renderer.onUpdateVisual(item);
        } else {
            statsGrid.innerHTML = '<div style="padding:20px; color:#666;">[ SYSTEM: 暂未定义该分类渲染器 ]</div>';
        }

        // 3. 加载图片
        handleImageLoad(item, activeTab);

        // 打字机接口
        window.triggerGlobalTypewriter = function(text) {
            if (typeof startTypewriter === "function") {
                // 执行你页面上统一的打字机动画
                startTypewriter(text || ">> SYSTEM: NO DATA LOG.");
            } else {
                const logElem = document.getElementById('typewriter-text');
                if (logElem) logElem.innerText = ">> " + text;
            }
        };
    }

    // --- 辅助功能 ---

    // 全局星级切换（由 zhanche_zhuangbei.js 里的按钮点击）
    window.switchVehicleStar = function(idx) {
        window.currentStarIdx = idx;
        const activeTab = document.querySelector('.tab-btn.active').innerText;
        const renderer = PageRenderers[activeTab];
        if (window.lastSelectedItem && renderer) {
            // 局部刷新属性网格，不重写整个详情页
            document.getElementById('stats-grid').innerHTML = renderer.renderStats(window.lastSelectedItem);
        }
    };

    function startTypewriter(text) {
        const elem = document.getElementById('desc-text');
        const scroller = document.getElementById('detail-scroller');
        scroller.scrollTop = 0;
        clearInterval(typewriterTimer);
        elem.innerText = "";
        let i = 0;
        typewriterTimer = setInterval(() => {
            if (i < text.length) {
                elem.innerText += text.charAt(i++);
                elem.scrollTop = elem.scrollHeight;
            } else { clearInterval(typewriterTimer); }
        }, 12);
    }

    // 统一图片加载逻辑
    function handleImageLoad(item, activeTab) {
        const imgContainer = document.getElementById('img-container');
        const itemName = item.名称;
        const formats = ['png', 'jpg', 'webp'];
        const tryLoad = (fIdx) => {
            if (fIdx >= formats.length) {
                imgContainer.innerHTML = '<span style="color:#333;">NO_SIGNAL</span>';
                return;
            }
            const testPath = `img/${activeTab}/${itemName}.${formats[fIdx]}`;
            const img = new Image();
            img.onload = () => imgContainer.innerHTML = `<img src="${testPath}" style="max-width:90%; max-height:90%; object-fit:contain;">`;
            img.onerror = () => tryLoad(fIdx + 1);
            img.src = testPath;
        };
        tryLoad(0);
    }


    // 添加这个函数作为按钮的直接入口
    window.handleManualGlobalSearch = async function() {
    const query = document.getElementById('db-search').value.trim().toLowerCase();
    if (!query) return mmAlert("请输入关键词", "warning");

    const tabs = Array.from(document.querySelectorAll('.tab-btn')).map(btn => btn.innerText);
    let allMatchedResults = [];



    for (const cat of tabs) {
        try {
            const res = await fetch(`data/${encodeURIComponent(cat)}.json`);
            const raw = await res.json();
            const data = Array.isArray(raw) ? raw : (raw.data || []);

            // 拍平数据（处理战车装备的分组结构）
            let flatData = [];
            if (cat === "战车装备" && data.length > 0 && data[0].items) {
                data.forEach(g => { flatData = flatData.concat(g.items); });
            } else {
                flatData = data;
            }

            // 执行多维度筛选
            const matches = flatData.filter(it =>
                (it.名称 && it.名称.toLowerCase().includes(query)) ||
                (it.属性 && it.属性.toLowerCase().includes(query)) ||
                (it.特性 && it.特性.toLowerCase().includes(query)) ||
                (it.改造支系 && it.改造支系.toLowerCase().includes(query))
            ).map(it => ({ ...it, originCat: cat })); // 标记来源，方便点击跳转

            allMatchedResults = allMatchedResults.concat(matches);
        } catch (e) { console.warn(e); }
    }

    if (allMatchedResults.length === 0) {
        mmAlert(`全库未发现匹配项: [${query}]`, 'warning');
        execFilter(); // 回复原状
        return;
    }

    // 渲染搜索结果列表
    renderSearchResultsList(allMatchedResults, query);
};

    window.resetSearch = function() {
    // 1. 获取搜索框并清空
    const searchInput = document.getElementById('db-search');
    if (searchInput) searchInput.value = "";

    // 2. 获取当前正在查看的 Tab 名称
    const activeTab = document.querySelector('.tab-btn.active')?.innerText;

    if (activeTab) {
        // 3. 重新调用加载分类，isJump 设为 false 以确保恢复默认首项显示
        loadCategory(activeTab, false);
    }
};

function renderSearchResultsList(results, query) {
    const container = document.getElementById('list-content');


    // 按来源分类进行展示
    const groups = {};
    results.forEach(it => {
        if (!groups[it.originCat]) groups[it.originCat] = [];
        groups[it.originCat].push(it);
    });

    for (const [catName, items] of Object.entries(groups)) {
        const groupDiv = document.createElement('div');
        groupDiv.className = 'list-group-wrapper';
        groupDiv.innerHTML = `
            <div class="sticky-group-header">
                <span class="title-text" style="color:#ffae00;">[ ${catName} ]</span>
            </div>
            <ul class="group-item-list"></ul>`;

        const ul = groupDiv.querySelector('ul');
        items.forEach(item => {
            const li = document.createElement('li');
            li.className = 'nav-item search-result-item';
            li.innerText = item.名称;
            li.onclick = async (e) => {
                e.stopPropagation();
                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                li.classList.add('active');

                // 视觉切换 Tab
                const targetTab = document.getElementById(`t-${item.originCat}`);
                if (targetTab) {
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    targetTab.classList.add('active');
                }

                // 核心：直接渲染详情，不重新加载分类列表
                showDetail(item, item.originCat);
            };
            ul.appendChild(li);
        });
        container.appendChild(groupDiv);
    }
}

    // --- 全局状态逻辑修复 ---
    window.pendingTargetName = null; // 用于存储跨分类跳转的目标名称

    /**
     * 全局跨分类搜索并跳转
     * @param {string} targetName 目标物品或底盘的名称
     */
    window.globalSearchAndJump = async function(targetName) {
    if (!targetName) return;
    const query = targetName.toLowerCase().trim();
    const tabs = Array.from(document.querySelectorAll('.tab-btn')).map(btn => btn.innerText);

    // 记录状态，防止 renderList 自动点击第一项
    window.pendingTargetName = targetName;

    for (const cat of tabs) {
        try {
            const res = await fetch(`data/${encodeURIComponent(cat)}.json`);
            if (!res.ok) continue;
            const raw = await res.json();
            const data = Array.isArray(raw) ? raw : (raw.data || []);

            let targetItem = null;

            // 精确搜索
            const findInList = (list) => list.find(it =>
                it.名称 === targetName || (it.名称 && it.名称.toLowerCase() === query)
            );
            // 模糊搜索
           ` const fuzzyInList = (list) => list.find(it =>
                it.名称 && it.名称.toLowerCase().includes(query)
            );`

            // 1. 尝试在当前分类查找（优先精准，后模糊）
            if (cat === "战车装备" && data.length > 0 && data[0].items) {
                // 处理分组格式的战车数据
                for (const group of data) {
                    targetItem = findInList(group.items) || fuzzyInList(group.items);
                    if (targetItem) break;
                }
            } else {
                // 处理平铺格式的数据
                targetItem = findInList(data) || fuzzyInList(data);
            }

            if (targetItem) {
                // 跳转时 isJump 设为 true，清空搜索框以显示完整列表
                await loadCategory(cat, true);

                showDetail(targetItem);

                setTimeout(() => {
                    highlightAndScrollTo(targetItem.名称);
                    window.pendingTargetName = null; // 定位结束，清除状态
                }, 300);
                return;
            }
        } catch (e) { console.warn(e); }
    }
    window.pendingTargetName = null;
    mmAlert(`数据库未发现包含 [${targetName}] 的条目`, 'warning');
};

    /**
     * 辅助函数：系统弹窗 (保持不变)
     */
    function mmAlert(message, type = 'info') {
        const modal = document.getElementById('custom-modal');
        const box = document.getElementById('modal-box');
        const msgArea = document.getElementById('modal-message');
        const titleArea = document.getElementById('modal-title');

        if (!modal || !box) return;

        msgArea.innerText = message;
        titleArea.innerText = type === 'warning' ? 'SYSTEM WARNING' : 'SYSTEM MESSAGE';

        if (type === 'warning') {
            box.classList.add('warning');
        } else {
            box.classList.remove('warning');
        }

        modal.style.display = 'flex';
    }

    function closeModal() {
        const modal = document.getElementById('custom-modal');
        if (modal) modal.style.display = 'none';
    }


</script>

</body>
</html>